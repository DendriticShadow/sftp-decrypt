AWSTemplateFormatVersion: '2010-09-09'
Description: 'S3 buckets for SFTP Transfer Family and PGP decryption (simplified)'

Parameters:
  ProjectName:
    Type: String
    Default: 'sftp-decrypt'
    Description: Project name for resource naming and tagging

  SourceBucketName:
    Type: String
    Description: Name for source S3 bucket (encrypted files from Transfer Family)

  DestinationBucketName:
    Type: String
    Description: Name for destination S3 bucket (decrypted files)

Conditions:
  CreateSeparateDestinationBucket: !Not [!Equals [!Ref SourceBucketName, !Ref DestinationBucketName]]

Resources:
  # ============================================================================
  # Source Bucket (Encrypted Files)
  # ============================================================================
  SourceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref SourceBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Ref SourceBucketName
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: 'SFTP encrypted files'

  # ============================================================================
  # Destination Bucket (Decrypted Files)
  # ============================================================================
  DestinationBucket:
    Type: AWS::S3::Bucket
    Condition: CreateSeparateDestinationBucket
    Properties:
      BucketName: !Ref DestinationBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Ref DestinationBucketName
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: 'Decrypted files'

Outputs:
  SourceBucketName:
    Description: Source S3 bucket name
    Value: !Ref SourceBucket
    Export:
      Name: !Sub '${ProjectName}-SourceBucketName'

  SourceBucketArn:
    Description: Source S3 bucket ARN
    Value: !GetAtt SourceBucket.Arn
    Export:
      Name: !Sub '${ProjectName}-SourceBucketArn'

  DestinationBucketName:
    Description: Destination S3 bucket name (same as source if not separate)
    Value: !If
      - CreateSeparateDestinationBucket
      - !Ref DestinationBucket
      - !Ref SourceBucket
    Export:
      Name: !Sub '${ProjectName}-DestinationBucketName'

  DestinationBucketArn:
    Description: Destination S3 bucket ARN
    Value: !If
      - CreateSeparateDestinationBucket
      - !GetAtt DestinationBucket.Arn
      - !GetAtt SourceBucket.Arn
    Export:
      Name: !Sub '${ProjectName}-DestinationBucketArn'
